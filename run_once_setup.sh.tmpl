#!/bin/sh

# STEP 0: Define usefull functions. ############################################
# Install function for gitflow. ################################################
install_gitflow() {
    cd $1
    wget -q https://raw.githubusercontent.com/petervanderdoes/gitflow-avh/develop/contrib/gitflow-installer.sh
    PREFIX=$1 bash gitflow-installer.sh install stable
    rm -fr gitflow-installer.sh gitflow
}

# STEP 1: Generate the machine configuration to obtain a standalone script. ####
{{- if contains "spiro" .chezmoi.hostname }}
# Export proxy for git clone, wget, etc at ONERA. ##############################
module purge
module load python/3.6.1
export http_proxy=http://proxy.onera:80
export https_proxy=http://proxy.onera:80
export no_proxy=.onera.net,.onera.fr,.onecert.fr
{{- end }}

# STEP 2: Install. #############################################################
{{- if contains "freyja" .chezmoi.hostname }}
# Install brew on MacOs freyja. ################################################
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
# Install brew packages on MacOs freyja. #######################################
brew install zsh git wget vim font-fira-code gcc lmod git-flow-avh
brew install python python@3.10 python@3.9 python@3.8 python@3.7
brew install imagemagick ffmpeg pandoc pandoc-crossref
# Install ViZiR4 on MacOs freyja. ##############################################
cd $HOME/Downloads
wget --no-check-certificate  https://pyamg.saclay.inria.fr/download/vizir/exes/Mac/vizir4.2022.03.01.dmg
hdiutil mount vizir4.2022.03.01.dmg
sudo cp -r /Volumes/vizir4/vizir4.app /Applications
hdiutil unmount "/Volumes/vizir4"
rm vizir4.2022.03.01.dmg
{{- end }}

{{- if contains "ldmpe055z" .chezmoi.hostname }}
# Install gitflow on CentOS 8 ldmpe055z. #######################################
install_gitflow /stck/$USER/wkdir/ldmpe055z
# Install clang-format on CentOS 8 ldmpe055z. ##################################
cd /stck/$USER/wkdir/ldmpe055z/bin
wget https://github.com/llvm/llvm-project/releases/download/llvmorg-13.0.0/clang+llvm-13.0.0-x86_64-linux-gnu-ubuntu-20.04.tar.xz
tar xf clang+llvm-13.0.0-x86_64-linux-gnu-ubuntu-20.04.tar.xz
cp clang+llvm-13.0.0-x86_64-linux-gnu-ubuntu-20.04/bin/clang-format .
rm clang+llvm-13.0.0-x86_64-linux-gnu-ubuntu-20.04.tar.xz
rm -fr clang+llvm-13.0.0-x86_64-linux-gnu-ubuntu-20.04
# Install vizir on CentOS 8 ldmpe055z. #########################################
cd /stck/$USER/wkdir/ldmpe055z/bin
wget --no-check-certificate https://pyamg.saclay.inria.fr/download/vizir/exes/Linux/vizir4_centos.2021.07.06.tar.gz
tar xzvf vizir4_centos.2021.07.06.tar.gz
cp vizir4_centos.2021.07.06/vizir4 .
rm vizir4_centos.2021.07.06.tar.gz
rm -fr vizir4_centos.2021.07.06
{{- end }}

{{- if contains "spiro" .chezmoi.hostname }}
# Install gitflow on CentOS 7 spiro. ###########################################
install_gitflow /stck/$USER/wkdir/spiro
# Install ZSH on CentOS 7 spiro. ###############################################
cd /stck/$USER/wkdir/src
if [[ -d "zsh" ]]
then
    rm -fr zsh
fi
git clone https://github.com/zsh-users/zsh.git
cd zsh
git checkout zsh-5.8
./Util/preconfig
./configure --prefix=/stck/$USER/wkdir/spiro
make -j48 install
cd ..
rm -fr zsh
{{- end }}

# Install antigen: the zsh package manager. ####################################
curl -L git.io/antigen > ~/.antigen.zsh
# Install the spacevim distribution. ###########################################
curl -sLf https://spacevim.org/install.sh | bash

# EOF. #########################################################################
